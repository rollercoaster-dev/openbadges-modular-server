#!/usr/bin/env sh

echo "üîç Running pre-push checks..."

# Get all staged and committed files that haven't been pushed yet
CHANGED_FILES=$(git diff --name-only --cached --diff-filter=ACMR | grep "\.ts$" || true)
COMMITTED_FILES=$(git diff --name-only origin/main...HEAD | grep "\.ts$" || true)

# Combine the lists and remove duplicates
ALL_FILES=$(echo "$CHANGED_FILES\n$COMMITTED_FILES" | sort | uniq | grep -v "^$")

if [ -n "$ALL_FILES" ]; then
  echo "üìù Linting changed files..."
  echo "$ALL_FILES" | xargs bun eslint --fix
  LINT_EXIT_CODE=$?

  echo "üîé Type checking changed files..."
  echo "$ALL_FILES" | xargs bun tsc-files --noEmit
  TYPE_EXIT_CODE=$?

  # Run tests related to changed files
  echo "üß™ Running tests..."
  
  # First check if we have any changes in test files
  TEST_FILES=$(echo "$ALL_FILES" | grep "\.test\.ts$" || true)
  
  if [ -n "$TEST_FILES" ]; then
    echo "Running changed test files..."
    echo "$TEST_FILES" | xargs bun test
    TEST_SPECIFIC_EXIT_CODE=$?
  fi
  
  # Also run a general test suite to ensure nothing is broken
  echo "Running general test suite..."
  bun test
  TEST_EXIT_CODE=$?
  
  # Check if any of the commands failed
  if [ $LINT_EXIT_CODE -ne 0 ] || [ $TYPE_EXIT_CODE -ne 0 ] || [ $TEST_EXIT_CODE -ne 0 ] || [ "${TEST_SPECIFIC_EXIT_CODE:-0}" -ne 0 ]; then
    echo "‚ùå Pre-push checks failed. Please fix the issues before pushing."
    exit 1
  fi
  
  echo "‚úÖ All pre-push checks passed!"
else
  echo "‚ÑπÔ∏è No TypeScript files changed, running minimal checks."
  
  # Even if no TS files changed, we should still run tests
  echo "üß™ Running tests..."
  bun test
  TEST_EXIT_CODE=$?
  
  if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Tests failed. Please fix the issues before pushing."
    exit 1
  fi
  
  echo "‚úÖ All pre-push checks passed!"
fi
