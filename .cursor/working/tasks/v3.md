# Open Badges v3.0 Compliance - Detailed Task List (Approx. 1 Story Point Each)

This document outlines the detailed tasks required to achieve full Open Badges v3.0 compliance, based on the previously agreed-upon implementation plan. Each task is estimated to be approximately 1 story point.

For each phase create a new branch and PR for review. Each task should hav it's own commit.

## Phase 1: Critical v3.0 Compliance (Approx. 20-30 tasks)

### Priority 1.1: Fix Issuer Field in VerifiableCredential (Approx. 10 tasks)

- [ ] Task 1.1.1: Analyze current issuer handling in Assertion entity and serialization.
- [ ] Task 1.1.2: Identify specific required issuer fields and structure in v3.0 VC spec.
- [ ] Task 1.1.3: Update [`src/domains/assertion/assertion.entity.ts`](src/domains/assertion/assertion.entity.ts) to include all required v3.0 issuer fields.
- [ ] Task 1.1.4: Design database schema changes to support required issuer fields in assertions.
- [ ] Task 1.1.5: Write database migration script to add `issuer_id` foreign key to the assertions table.
- [ ] Task 1.1.6: Write database migration script for data migration to populate the new issuer field from existing data.
- [ ] Task 1.1.7: Update Assertion API controller logic to ensure the issuer is always populated correctly on v3.0 assertion creation.
- [ ] Task 1.1.8: Update Assertion API controller logic to fetch and include full issuer data for v3.0 serialization responses.
- [ ] Task 1.1.9: Add unit tests for the updated Assertion entity and database mappers related to the issuer field.
- [ ] Task 1.1.10: Add integration tests for the database migration scripts.
- [ ] Task 1.1.11: Add API tests to verify the correct presence and structure of the issuer field in v3.0 assertion responses.

### Priority 1.2: Complete StatusList2021 Implementation (Approx. 12 tasks)

- [ ] Task 1.2.1: Conduct detailed research on the StatusList2021 specification and implementation requirements.
- [ ] Task 1.2.2: Design the data model for storing StatusList2021 information in the database.
- [ ] Task 1.2.3: Write database migration script to add necessary tables and fields for StatusList2021.
- [ ] Task 1.2.4: Create the StatusList Service class (`src/core/status-list.service.ts`).
- [ ] Task 1.2.5: Implement the core logic within StatusListService for generating StatusList2021 bitstrings.
- [ ] Task 1.2.6: Implement the logic within StatusListService for updating a credential's status within its corresponding bitstring.
- [ ] Task 1.2.7: Add the API endpoint `GET /v3/status-lists/:id` to retrieve a specific status list.
- [ ] Task 1.2.8: Add the API endpoint `POST /v3/credentials/:id/status` to update the status of a specific credential.
- [ ] Task 1.2.9: Integrate the StatusListService with the Assertion entity and serialization process to include `credentialStatus`.
- [ ] Task 1.2.10: Add unit tests for the StatusListService logic (bitstring generation, status updates).
- [ ] Task 1.2.11: Add API tests for the new status list endpoints (`GET` and `POST`).
- [ ] Task 1.2.12: Add E2E tests to verify the end-to-end functionality of status list creation and status updates.

### Priority 1.3: Implement JWKS Endpoint (Approx. 9 tasks)

- [ ] Task 1.3.1: Research the JSON Web Key (JWK) format and the JWK Set (JWKS) endpoint specification (`.well-known/jwks.json`).
- [ ] Task 1.3.2: Design the data model for storing public keys in JWK format, considering existing key storage.
- [ ] Task 1.3.3: Write database migration script to update key storage schema if necessary to accommodate JWK format.
- [ ] Task 1.3.4: Create the JWKS Controller class (`src/api/controllers/jwks.controller.ts`).
- [ ] Task 1.3.5: Implement the API endpoint `GET /.well-known/jwks.json` to return public keys in the required JWK Set format.
- [ ] Task 1.3.6: Update the Key Service to support converting existing public keys to the JWK format.
- [ ] Task 1.3.7: Implement a basic key rotation mechanism within the Key Service (e.g., generating new keys, marking old ones as inactive but available for verification).
- [ ] Task 1.3.8: Add unit tests for the Key Service's JWK conversion and basic key rotation logic.
- [ ] Task 1.3.9: Add API tests for the JWKS endpoint to verify the response format and content.

## Phase 2: API Compliance & Endpoint Alignment (Approx. 15-20 tasks)

### Priority 2.1: Implement v3.0 Endpoint Naming (Approx. 7 tasks)

- [ ] Task 2.1.1: Design the new v3.0 compliant API routes (`/achievements` for BadgeClasses, `/credentials` for Assertions).
- [ ] Task 2.1.2: Implement the new routes for the Achievement (BadgeClass) controller.
- [ ] Task 2.1.3: Implement the new routes for the Credential (Assertion) controller.
- [ ] Task 2.1.4: Configure the existing `/v3/badge-classes` and `/v3/assertions` routes to act as aliases for backward compatibility.
- [ ] Task 2.1.5: Add appropriate deprecation warnings to the alias endpoints in API responses or headers.
- [ ] Task 2.1.6: Update the API documentation (`docs/api-documentation.md`) to clearly reflect the new endpoints and the deprecation of old ones.
- [ ] Task 2.1.7: Add API tests to ensure the new endpoint names function correctly and the old aliases still work with warnings.

### Priority 2.2: Implement Batch Operations (Approx. 7 tasks)

- [x] Task 2.2.1: Design the API endpoints for batch operations (`POST /v3/credentials/batch`, `GET /v3/credentials/batch?ids=...`, `PUT /v3/credentials/batch/status`).
  **Implementation Plan:**
  - Files to modify: `src/api/dtos/assertion.dto.ts`, `src/api/validation/assertion.schemas.ts`, `src/api/validation/dto.validator.ts`
  - Create `BatchCreateCredentialsDto`, `BatchRetrieveCredentialsDto`, `BatchUpdateCredentialStatusDto` interfaces
  - Add validation functions for each batch operation
  - Design error handling for partial failures in batch operations

- [x] Task 2.2.2: Implement the batch credential creation endpoint (`POST /v3/credentials/batch`).
  **Implementation Plan:**
  - Files to modify: `src/api/controllers/assertion.controller.ts`, `src/api/api.router.ts`, repository interfaces and implementations
  - Add `createAssertionsBatch` method to controller
  - Leverage existing `src/infrastructure/database/utils/batch-operations.ts` utilities
  - Implement transaction-based batch creation with rollback on failure
  - Return detailed results including successful and failed operations

- [ ] Task 2.2.3: Implement the batch credential retrieval endpoint (`GET /v3/credentials/batch?ids=...`).
  **Implementation Plan:**
  - Files to modify: `src/api/controllers/assertion.controller.ts`, `src/api/api.router.ts`, repository interfaces and implementations
  - Add `getAssertionsBatch` method to controller
  - Parse comma-separated IDs from query parameter
  - Implement efficient batch retrieval using IN queries
  - Handle missing credentials gracefully, return results in consistent order

- [ ] Task 2.2.4: Implement the batch credential status update endpoint (`PUT /v3/credentials/batch/status`).
  **Implementation Plan:**
  - Files to modify: `src/api/controllers/assertion.controller.ts`, `src/api/api.router.ts`, repository implementations
  - Add `updateAssertionStatusBatch` method to controller
  - Integrate with existing StatusList2021 implementation (when available)
  - Support both revocation and suspension status updates
  - Use transaction-based updates for consistency

- [ ] Task 2.2.5: Add unit tests for the core logic handling batch operations (e.g., parsing input, calling service methods).
  **Implementation Plan:**
  - Files to create: `tests/api/batch-operations.test.ts`, `tests/domains/assertion/assertion.repository.batch.test.ts`
  - Test batch validation logic and partial failure scenarios
  - Test transaction rollback behavior
  - Mock repository dependencies

- [ ] Task 2.2.6: Add API tests for all batch endpoints to verify request/response formats and functionality.
  **Implementation Plan:**
  - Files to modify: `tests/api/api-endpoints.test.ts`, `tests/e2e/assertion.e2e.test.ts`
  - Test all three batch endpoints with various scenarios
  - Test error scenarios and edge cases
  - Verify response formats, status codes, authentication and authorization

- [ ] Task 2.2.7: Add performance tests to measure the efficiency of batch operations with varying data sizes.
  **Implementation Plan:**
  - Files to create: `tests/performance/batch-operations.performance.test.ts`
  - Test with varying batch sizes (10, 100, 1000 items)
  - Measure response times and memory usage
  - Compare batch vs individual operation performance, set benchmarks

### Priority 2.3: Enhanced Proof Support (Approx. 13 tasks)

- [ ] Task 2.3.1: Research the JWS/JWT proof format specifically for Open Badges v3.0 and Verifiable Credentials.
- [ ] Task 2.3.2: Identify and evaluate suitable libraries or existing implementations for JWS/JWT in the project's technology stack.
- [ ] Task 2.3.3: Integrate the chosen JWS/JWT library into the project.
- [ ] Task 2.3.4: Implement the logic for generating JWS/JWT proofs for v3.0 assertions.
- [ ] Task 2.3.5: Implement the logic for verifying JWS/JWT proofs.
- [ ] Task 2.3.6: Update the Assertion serialization process to include JWS/JWT proofs alongside DataIntegrityProof.
- [ ] Task 2.3.7: Design the data model changes required to support multiple proofs per assertion.
- [ ] Task 2.3.8: Write database migration script to add necessary fields/tables for multiple proofs.
- [ ] Task 2.3.9: Update the Assertion entity and database mappers to handle multiple proofs.
- [ ] Task 2.3.10: Update the Assertion API to correctly handle multiple proofs on creation and retrieval.
- [ ] Task 2.3.11: Add unit tests for JWS/JWT proof generation and verification logic.
- [ ] Task 2.3.12: Add API tests to verify the handling and inclusion of multiple proofs in responses.
- [ ] Task 2.3.13: Add E2E tests to verify the end-to-end process of creating, retrieving, and verifying assertions with JWS/JWT and multiple proofs.

## Phase 3: Advanced v3.0 Features (Approx. 20-25 tasks)

### Priority 3.1: Achievement Versioning & Relationships (Approx. 13 tasks)

- [ ] Task 3.1.1: Research the specific requirements for achievement versioning in Open Badges v3.0.
- [ ] Task 3.1.2: Research the specific requirements for the `related` and `endorsement` fields in v3.0.
- [ ] Task 3.1.3: Design the data model changes needed to support achievement versioning.
- [ ] Task 3.1.4: Design the data model changes needed to support `related` and `endorsement` relationships.
- [ ] Task 3.1.5: Write database migration script to add necessary fields/tables for versioning and relationships.
- [ ] Task 3.1.6: Update the BadgeClass entity to include versioning fields (e.g., `version`, `previousVersion`).
- [ ] Task 3.1.7: Update the BadgeClass entity to include `related` and `endorsement` fields.
- [ ] Task 3.1.8: Implement API endpoints for managing achievement relationships (e.g., linking related achievements).
- [ ] Task 3.1.9: Implement validation logic to prevent circular dependencies in achievement relationships.
- [ ] Task 3.1.10: Update the BadgeClass API controller to handle creation and updates with versioning and relationships.
- [ ] Task 3.1.11: Add unit tests for the updated BadgeClass entity and relationship logic.
- [ ] Task 3.1.12: Add API tests for the new versioning and relationship endpoints.
- [ ] Task 3.1.13: Add E2E tests to verify the end-to-end functionality of achievement versioning and relationships.

### Priority 3.2: Credential Schema Validation (Approx. 9 tasks)

- [ ] Task 3.2.1: Research the `credentialSchema` property in Open Badges v3.0 and its role in validation.
- [ ] Task 3.2.2: Identify and evaluate a suitable JSON Schema validation library for the project.
- [ ] Task 3.2.3: Integrate the chosen JSON Schema validation library into the project.
- [ ] Task 3.2.4: Create a dedicated Schema Validation Service.
- [ ] Task 3.2.5: Implement the logic within the Schema Validation Service for validating credentials against external JSON schemas referenced by `credentialSchema`.
- [ ] Task 3.2.6: Implement logic for applying custom validation rules beyond the standard schema if required.
- [ ] Task 3.2.7: Integrate the Schema Validation Service into the Assertion creation and update flow to perform validation.
- [ ] Task 3.2.8: Add unit tests for the schema validation logic using various valid and invalid schemas/credentials.
- [ ] Task 3.2.9: Add API tests to verify that invalid credentials are rejected with appropriate error messages due to schema validation failures.

### Priority 3.3: Refresh Service Implementation (Approx. 7 tasks)

- [ ] Task 3.3.1: Research the `refreshService` property in Open Badges v3.0 and its intended functionality.
- [ ] Task 3.3.2: Design the data model or mechanism required to support credential refresh requests.
- [ ] Task 3.3.3: Create a dedicated Refresh Service.
- [ ] Task 3.3.4: Implement the core logic within the Refresh Service for handling a credential refresh request.
- [ ] Task 3.3.5: Add the API endpoint `POST /v3/credentials/:id/refresh`.
- [ ] Task 3.3.6: Add unit tests for the Refresh Service logic.
- [ ] Task 3.3.7: Add API tests for the refresh endpoint.

## Phase 4: Testing & Validation (Approx. 10-15 tasks)

### Priority 4.1: Comprehensive Test Suite (Approx. 10 tasks)

- [ ] Task 4.1.1: Review and understand the scope of the existing E2E tests, particularly `tests/e2e/obv3-compliance.e2e.test.ts`.
- [ ] Task 4.1.2: Expand the E2E test suite to cover all newly implemented v3.0 endpoints and features.
- [ ] Task 4.1.3: Expand E2E tests to specifically cover the verification of assertions with enhanced proof types (JWS/JWT, multiple proofs).
- [ ] Task 4.1.4: Expand E2E tests to cover the end-to-end functionality of the status list implementation.
- [ ] Task 4.1.5: Research and obtain access to the official OB3.0 test suite and compliance requirements.
- [ ] Task 4.1.6: Implement compliance tests that run the server's output against the official OB3.0 test vectors or suite.
- [ ] Task 4.1.7: Implement automated JSON-LD validation tests for v3.0 assertion outputs.
- [ ] Task 4.1.8: Implement automated schema validation tests using the new Schema Validation Service.
- [ ] Task 4.1.9: Review code coverage reports and add additional tests (unit, integration, E2E) to achieve 95%+ coverage for all new v3.0 code.
- [ ] Task 4.1.10: Refactor and organize the entire test suite for improved maintainability and clarity.

### Priority 4.2: External Validation (Approx. 5 tasks)

- [ ] Task 4.2.1: Research the 1EdTech validator and determine the best method for integrating testing against it.
- [ ] Task 4.2.2: Set up the process and environment for regularly testing the server's output against official external validators.
- [ ] Task 4.2.3: Run tests against official validators (like 1EdTech) and systematically address any compliance issues reported.
- [ ] Task 4.2.4: Define clear performance benchmarks for key operations, particularly batch operations and status list handling.
- [ ] Task 4.2.5: Implement performance tests and analyze results, optimizing code as needed to meet defined benchmarks.

## Additional Tasks (Cross-cutting/Refinement - Approx. 14 tasks)

- [ ] Task 5.1: Update the API documentation (`docs/api-documentation.md`) with comprehensive details on all new v3.0 features, endpoints, and request/response formats.
- [ ] Task 5.2: Update database documentation (`docs/database.md`, migrations guide) to reflect all schema changes made during v3.0 implementation.
- [ ] Task 5.3: Conduct a thorough review and update of `openbadges-types` usage throughout the codebase to ensure full v3.0 type compliance.
- [ ] Task 5.4: Implement DID:web support as an alternative mechanism for key discovery.
- [ ] Task 5.5: Refine the key rotation mechanism and ensure seamless integration with the JWKS endpoint.
- [ ] Task 5.6: Implement support for specifying and using external verification methods.
- [ ] Task 5.7: Implement a caching mechanism for verification results to improve performance.
- [ ] Task 5.8: Address inconsistencies in how entities are embedded versus referenced in API responses for v3.0.
- [ ] Task 5.9: Implement pagination for API endpoints that can return large result sets.
- [ ] Task 5.10: Review and refine error handling mechanisms for all new v3.0 features and endpoints.
- [ ] Task 5.11: Update the environment variables reference (`docs/environment-variables-reference.md`) to include any new configuration variables introduced.
- [ ] Task 5.12: Review and update the CI pipeline guide (`docs/ci-pipeline-guide.md`) to incorporate new tests and validation steps.
- [ ] Task 5.13: Conduct a final, comprehensive code review of all changes made for v3.0 compliance.
- [ ] Task 5.14: Prepare detailed release notes summarizing all changes, new features, and potential breaking changes (for aliases) for the v3.0 compliance update.